---

- name: SSHD default state
  set_fact:
    ssh_service_state: "started"

##
# Port configuration
- block:
    - name: SSH Port
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^Port "
        line: "Port {{ desired_ansible_ssh_port }}"
        state: present
      register: config

    - name: Trigger restart
      set_fact:
        ssh_service_state: "restarted"
      when: config.changed
  when: desired_ansible_ssh_port|default("") != ""

# Allowed Groups
- name: SSH AllowGroups
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^AllowGroups "
    line: "AllowGroups remotessh"
    state: present
  register: config

- name: Trigger restart
  set_fact:
    ssh_service_state: "restarted"
  when: config.changed

# Disable remote root login
- name: SSH PermitRootLogin
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^PermitRootLogin "
    line: "PermitRootLogin no"
    state: present
  register: config

- name: Trigger restart
  set_fact:
    ssh_service_state: "restarted"
  when: config.changed

# Password authentication
- name: SSH PasswordAuthentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^PasswordAuthentication "
    line: "PasswordAuthentication yes"
    state: present
  register: config

- name: Trigger restart
  set_fact:
    ssh_service_state: "restarted"
  when: config.changed

# SSH service state
- name: SSH Server Enabled
  service:
    name: sshd
    enabled: yes
    state: "{{ ssh_service_state }}"

# If the port was changed, lets change ansible_ssh_port to match
- name: Update ssh port
  set_fact:
    ansible_ssh_port: "{{ desired_ansible_ssh_port }}"
  when: desired_ansible_ssh_port|default("") != ""
  delegate_to: localhost
